#!/system/bin/sh
# Vacuum and reindex sqlite databases on boot

LOGCAT="log -p i -t boot_sqlite3"
LOG=/system/etc/logs/boot_sqlite3.log

function sqlite3() {
	# Mount system
    	$LOGCAT "Mounting /system";
    	mount -o remount,rw /system;

	# Check if log dir exists
	if [ ! -d /system/etc/logs ]; then
		$LOGCAT "Error: /system/etc/logs not found!";
	fi
	
    	# Create log file
    	$LOGCAT "Creating new LOG file";
    	date > $LOG;
	
	# Check if logfile was created properly
	if [ ! -e $LOG ]; then
    	    $LOGCAT "Error: Unable to create logfile!"
    	fi
	
	$LOGCAT "Beginning 1 minute delay..."
	sleep 60;
	$LOGCAT "Executing SQlite3!"
	
	echo "Beginning /data optimization" | tee -a $LOG
	x=0;
	for i in \
	`find /data -iname "*.db"`;
	do \
		/system/xbin/sqlite3 $i 'VACUUM;' | tee -a $LOG;
		/system/xbin/sqlite3 $i 'REINDEX;' | tee -a $LOG;
		x=$((x+1));
	done;
	$LOGCAT "Optimized $x /data databases";
	echo "Optimized $x /data databases" | tee -a $LOG
	echo " " | tee -a $LOG
	
	echo "Beginning /sdcard optimization" | tee -a $LOG
	x=0;
	for i in \
	`find /sdcard -iname "*.db"`;
	do \
		/system/xbin/sqlite3 $i 'VACUUM;' | tee -a $LOG;
		/system/xbin/sqlite3 $i 'REINDEX;' | tee -a $LOG;
		x=$((x+1));
	done;
	$LOGCAT "Optimized $x /sdcard databases";
	echo "Optimized $x /sdcard databases" | tee -a $LOG

	$LOGCAT "/system/etc/11sqlite3 complete!";
	echo "SQlite3 optimization complete!" | tee -a $LOG
}

$LOGCAT "Running /system/etc/11sqlite3...";
sqlite3 &
