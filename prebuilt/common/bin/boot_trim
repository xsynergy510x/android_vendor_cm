#!/system/bin/sh
# TRIM fat on every boot

LOGCAT="log -p i -t boot_trim"
LOG=/data/local/logs/boot_trim.log

function log() {
	$LOGCAT $1
	echo $1 | tee -a $LOG
}

function trim() {
	# Check if log dir exists
	if [ ! -d /system/etc/logs ]; then
		$LOGCAT "Error: /system/etc/logs dir not found!";
		mkdir -p /data/local/logs
		SUCCESS=$?
		if [[ $SUCCESS != 0 ]]; then
			$LOGCAT "Error: Unable to create /data/local/logs"
		fi
	fi

    	# Create log file
    	date > $LOG;
    	$log "Creating new LOG file";

    	if [ ! -e $LOG ]; then
        	$log "Error: Unable to create logfile!"
    	fi

	$log "Executing TRIM!"

    	# TRIM /system, if not F2FS
    	if ! mount | grep \/system | grep f2fs; then
    	    	$log "Trimming /system...";
    		fstrim -v /system 2>&1 | tee -a $LOG;
		SUCCESS=$?
		if [[ $SUCCESS == 0 ]]; then
			$log "Trimmed /system!"
		else
			$log "Error: Unable to trim /system!"
		fi
    	else
        	$log "/system formatted as F2FS, TRIM not available!"
    	fi

    	# TRIM /data, if not F2FS
    	if ! mount | grep \/data | grep f2fs; then
        	$log "Trimming /data...";
        	fstrim -v /data 2>&1 | tee -a $LOG;
		SUCCESS=$?
                if [[ $SUCCESS == 0 ]]; then
                        $log "Trimmed /data!"
                else
                        $log "Error: Unable to trim /data!"
                fi
    	else
        	$log "/data formatted as F2FS, TRIM not available!"
    	fi

    	# TRIM /cache, if not F2FS
   	if ! mount | grep \/cache | grep f2fs; then
        	$log "Trimming /cache...";
        	fstrim -v /cache 2>&1 | tee -a $LOG;
		SUCCESS=$?
                if [[ $SUCCESS == 0 ]]; then
                        $log "Trimmed /cache!"
                else
                        $log "Error: Unable to trim /cache!"
                fi
    	else
        	$log "/cache formatted as F2FS, TRIM not available!"
    	fi

    	$LOGCAT "boot_trim complete!";
}

$LOGCAT "Running boot_trim...";
su -c trim &
